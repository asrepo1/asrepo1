name: Weather Box

on:
  schedule:
    - cron: "0 * * * *" # Every hour
  workflow_dispatch: # Manual trigger

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Earth Engine API
        run: pip install earthengine-api

      - name: Fetch weather and update gist
        env:
          GH_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
          GEE_SERVICE_ACCOUNT_KEY: ${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}
          GIST_ID: 8fc319438657e698472538bf19a91c1d
          TZ: America/Los_Angeles
          LAT: "37.44783"
          LON: "-122.13604"
        run: |
          WEATHER_DATA=$(curl -sf "https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset,uv_index_max&hourly=temperature_2m,weather_code,relative_humidity_2m,wind_speed_10m,apparent_temperature,uv_index&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America/Los_Angeles&forecast_days=5")

          AQI_DATA=$(curl -sf "https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&hourly=pm2_5,pm10,us_aqi&timezone=America/Los_Angeles&forecast_days=1")

          # Sentinel-2 NDVI via Google Earth Engine (10m resolution)
          NDVI_DATA=$(python3 .github/scripts/canopy.py 2>/dev/null || echo '{"ndvi":0,"prev_ndvi":0,"date":""}')

          WEATHER=$(python3 -c "
          import json, sys
          from datetime import datetime

          weather = json.loads(sys.argv[1])
          aq = json.loads(sys.argv[2])
          canopy = json.loads(sys.argv[3])

          icons = {
            0:'â˜€',1:'ğŸŒ¤',2:'â›…',3:'â˜',45:'ğŸŒ«',48:'ğŸŒ«',51:'ğŸŒ¦',53:'ğŸŒ¦',55:'ğŸŒ¦',
            61:'ğŸŒ§',63:'ğŸŒ§',65:'ğŸŒ§',71:'ğŸŒ¨',73:'ğŸŒ¨',75:'ğŸŒ¨',80:'ğŸŒ§',81:'ğŸŒ§',82:'ğŸŒ§',
            95:'â›ˆ',96:'â›ˆ',99:'â›ˆ'
          }
          narrow = {'â˜€','â˜','â›…','â›ˆ'}
          def pad(ic):
              return ic + ' ' if ic in narrow else ic
          def moon_icon(date_str):
              dt = datetime.strptime(date_str, '%Y-%m-%d') if isinstance(date_str, str) else date_str
              ref = datetime(2000, 1, 6, 18, 14)
              age = ((dt - ref).total_seconds() / 86400) % 29.530588853
              phases = ['ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜']
              return phases[int((age / 29.530588853) * 8) % 8]
          def moon_phase(date_str):
              m = moon_icon(date_str)
              return m if m in ('ğŸŒ‘','ğŸŒ•') else ''

          days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']

          d = weather['daily']
          h = weather['hourly']

          now = datetime.now()
          hour_idx = 0
          for i, t in enumerate(h['time']):
              if datetime.strptime(t, '%Y-%m-%dT%H:%M') >= now:
                  hour_idx = i
                  break

          # --- Canopy from Google Earth Engine Sentinel-2 ---
          ndvi_val = canopy.get('ndvi', 0)
          ndvi_prev = canopy.get('prev_ndvi', 0)
          ndvi_date = canopy.get('date', '')

          if ndvi_val >= 0.6: canopy_dot = 'ğŸŸ¢'
          elif ndvi_val >= 0.4: canopy_dot = 'ğŸŸ¡'
          elif ndvi_val >= 0.2: canopy_dot = 'ğŸŸ '
          else: canopy_dot = 'ğŸ”´'

          delta = ndvi_val - ndvi_prev
          if delta > 0.02: trend = 'â†‘'
          elif delta < -0.02: trend = 'â†“'
          else: trend = 'â†’'

          ndvi_pct = round(ndvi_val * 100)
          ndvi_num = f'{ndvi_val:.2f}'
          if ndvi_val >= 0.9: leaf = 'ğŸŒ´'
          elif ndvi_val >= 0.75: leaf = 'ğŸŒ²'
          elif ndvi_val >= 0.6: leaf = 'ğŸŒ³'
          elif ndvi_val >= 0.45: leaf = 'ğŸŒ¿'
          elif ndvi_val >= 0.3: leaf = 'ğŸŒ±'
          elif ndvi_val >= 0.15: leaf = 'ğŸ‚'
          else: leaf = 'ğŸœ'
          ndvi_str = f'{leaf}{ndvi_pct}' if ndvi_val > 0 else 'ğŸ‚--'

          # --- AQI + weather stats ---
          aq_h = aq.get('hourly', {})
          aq_times = aq_h.get('time', [])
          aq_idx = 0
          for i, t in enumerate(aq_times):
              if datetime.strptime(t, '%Y-%m-%dT%H:%M') >= now:
                  aq_idx = max(0, i - 1)
                  break
          def safe(arr, idx):
              return (arr[min(idx, len(arr)-1)] if arr else 0) or 0
          us_aqi = safe(aq_h.get('us_aqi',[]), aq_idx)
          pm25 = safe(aq_h.get('pm2_5',[]), aq_idx)
          pm10 = safe(aq_h.get('pm10',[]), aq_idx)
          humidity = safe(h.get('relative_humidity_2m',[]), hour_idx)
          wind = safe(h.get('wind_speed_10m',[]), hour_idx)
          feels = safe(h.get('apparent_temperature',[]), hour_idx)
          uv = safe(h.get('uv_index',[]), hour_idx)
          sunrise = d.get('sunrise',[''])[0].split('T')[-1] if d.get('sunrise') else ''
          sunset = d.get('sunset',[''])[0].split('T')[-1] if d.get('sunset') else ''
          uv_max = d.get('uv_index_max',[0])[0] or 0

          # --- Comfort Index (0-100) ---
          comfort = 100.0
          # Temperature: ideal feels-like 62-75F
          if feels < 62: comfort -= min(30, (62 - feels) * 1.5)
          elif feels > 75: comfort -= min(30, (feels - 75) * 2)
          # Humidity: ideal 35-60%
          if humidity < 35: comfort -= min(12, (35 - humidity) * 0.6)
          elif humidity > 60: comfort -= min(15, (humidity - 60) * 0.5)
          # Wind: ideal 2-12 mph
          if wind > 12: comfort -= min(12, (wind - 12) * 1.2)
          elif wind < 2: comfort -= 3
          # AQI penalty
          comfort -= min(25, us_aqi * 0.2)
          # UV penalty (>6 is harsh)
          if uv > 6: comfort -= min(10, (uv - 6) * 2)
          # NDVI bonus: green surroundings boost comfort
          if ndvi_val > 0: comfort += min(5, ndvi_val * 8)
          comfort = max(0, min(100, round(comfort)))
          if comfort >= 80: c_dot = 'ğŸŸ¢'
          elif comfort >= 60: c_dot = 'ğŸŸ¡'
          elif comfort >= 40: c_dot = 'ğŸŸ '
          else: c_dot = 'ğŸ”´'

          # Parse sunrise/sunset for night detection
          sunrise_hour = int(sunrise.split(':')[0]) if sunrise else 7
          sunset_hour = int(sunset.split(':')[0]) if sunset else 20
          sunset_min = int(sunset.split(':')[1]) if sunset else 0
          def is_night(dt):
              return dt.hour > sunset_hour or (dt.hour == sunset_hour and dt.minute >= sunset_min) or dt.hour < sunrise_hour
          night_clear = {0,1,2}    # clear/partly cloudy - can see moon
          night_overcast = {3,45,48}  # overcast/fog - can't see moon
          night_rain = {51,53,55}  # drizzle codes - use ğŸŒ§ not ğŸŒ¦ (has sun)

          # Collect all sunrise/sunset datetimes from forecast
          sun_events = {}
          for i in range(len(d['time'])):
              sr = d.get('sunrise',[])[i] if i < len(d.get('sunrise',[])) else None
              ss = d.get('sunset',[])[i] if i < len(d.get('sunset',[])) else None
              if sr:
                  sr_dt = datetime.strptime(sr, '%Y-%m-%dT%H:%M')
                  sun_events[sr_dt.strftime('%Y-%m-%d-%H')] = ('sunrise', sr_dt)
              if ss:
                  ss_dt = datetime.strptime(ss, '%Y-%m-%dT%H:%M')
                  sun_events[ss_dt.strftime('%Y-%m-%d-%H')] = ('sunset', ss_dt)

          # Line 1: hourly forecast + NDVI
          parts = []
          skip_hours = set()
          # Find which hours to skip (closest hour to each sun event in range)
          hour_times = []
          for i in range(hour_idx, min(hour_idx + 8, len(h['time']))):
              hour_times.append((i, datetime.strptime(h['time'][i], '%Y-%m-%dT%H:%M')))
          for key, (icon, ev_dt) in sun_events.items():
              for idx, (i, ht) in enumerate(hour_times):
                  diff = abs((ev_dt - ht).total_seconds()) / 3600
                  if diff < 1:
                      # This sun event falls in this hour's window
                      # Skip the nearest rounded hour if it's close
                      if ev_dt.minute >= 30 and idx + 1 < len(hour_times):
                          skip_hours.add(hour_times[idx + 1][0])
                      break

          for i in range(hour_idx, min(hour_idx + 8, len(h['time']))):
              if i in skip_hours:
                  continue
              dt = datetime.strptime(h['time'][i], '%Y-%m-%dT%H:%M')
              # Check if a sun event falls in this hour
              key = dt.strftime('%Y-%m-%d-%H')
              if key in sun_events:
                  ev_type, ev_dt = sun_events[key]
                  ev_hr = ev_dt.strftime('%I:%M%p').lstrip('0').rstrip('M').lower()
                  if ev_type == 'sunset':
                      wc = h['weather_code'][i]
                      if wc in night_clear:
                          ic = moon_icon(dt)
                      else:
                          ic = 'ğŸŒ«'
                  else:  # sunrise - show daytime weather
                      ic = icons.get(h['weather_code'][i], '?')
                  parts.append(f'{ev_hr}{ic}')
              else:
                  hr = dt.strftime('%I%p').lstrip('0').rstrip('M').lower()
                  wc = h['weather_code'][i]
                  if is_night(dt) and wc in night_clear:
                      ic = moon_icon(dt)
                  elif is_night(dt) and wc in night_overcast:
                      ic = 'ğŸŒ«'
                  elif is_night(dt) and wc in night_rain:
                      ic = 'ğŸŒ§'
                  else:
                      ic = icons.get(wc, '?')
                  parts.append(f'{hr}{ic}')
          hourly_line = ' '.join(parts[:8])
          print(f'{hourly_line}  {ndvi_str}')

          # Lines 2-5: daily with spaced icons
          def day_icons(day_str):
              sample = [6, 9, 12, 15, 18, 21]
              r = []
              for j, t in enumerate(h['time']):
                  dt = datetime.strptime(t, '%Y-%m-%dT%H:%M')
                  if dt.strftime('%Y-%m-%d') == day_str and dt.hour in sample:
                      wc = h['weather_code'][j]
                      if is_night(dt) and wc in night_clear:
                          r.append(pad(moon_icon(dt)))
                      elif is_night(dt) and wc in night_overcast:
                          r.append(pad('ğŸŒ«'))
                      elif is_night(dt) and wc in night_rain:
                          r.append(pad('ğŸŒ§'))
                      else:
                          r.append(pad(icons.get(wc, 'â˜')))
              return ' '.join(r)

          prev_hi = round(d['temperature_2m_max'][0])
          shown_moon = set()
          for i in range(1, 5):
              dt = datetime.strptime(d['time'][i], '%Y-%m-%d')
              day = days[dt.weekday()]
              hi_t = round(d['temperature_2m_max'][i])
              hourly = day_icons(d['time'][i])
              rain = d['precipitation_probability_max'][i] or 0
              delta_t = hi_t - prev_hi
              moon = moon_phase(d['time'][i])
              alert = ''
              if moon and moon not in shown_moon:
                  alert = ' ' + moon
                  shown_moon.add(moon)
              elif delta_t <= -5: alert = ' ğŸ”»'
              elif rain >= 50: alert = ' ğŸŒŠ'
              print(f'{day} {hi_t:>2}Â° {hourly}{alert}')
              prev_hi = hi_t

          # Lines below fold (hidden from pinned preview)
          print()
          print(f'ğŸƒ Comfort {comfort}/100 {c_dot}')
          t_pen = min(30, (62-feels)*1.5) if feels<62 else min(30,(feels-75)*2) if feels>75 else 0
          h_pen = min(12,(35-humidity)*0.6) if humidity<35 else min(15,(humidity-60)*0.5) if humidity>60 else 0
          w_pen = min(12,(wind-12)*1.2) if wind>12 else 3 if wind<2 else 0
          a_pen = min(25, us_aqi*0.2)
          u_pen = min(10,(uv-6)*2) if uv>6 else 0
          n_bon = min(5, ndvi_val*8) if ndvi_val>0 else 0
          print(f'  temp {-round(t_pen)} hum {-round(h_pen)} wind {-round(w_pen)} aqi {-round(a_pen)} uv {-round(u_pen)} ndvi +{round(n_bon)}')
          src = 'Sentinel-2 10m' if ndvi_val > 0 else 'MODIS'
          ndvi_chg = f'{delta:+.2f}' if ndvi_val > 0 else '--'
          print(f'ğŸ›° NDVI {ndvi_num} ({ndvi_chg}) {trend} [{src}] {ndvi_date}')
          print(f'ğŸ’¨ AQI {us_aqi} | PM2.5 {round(pm25)} | PM10 {round(pm10)} ug/m3')
          sun_lbl = moon_icon(now) if is_night(now) else 'â˜€'
          print(f'ğŸŒ¡ Feels {round(feels)}Â° | UV {round(uv,1)}/{round(uv_max,1)} | {sun_lbl} {sunrise}-{sunset}')
          print(f'ğŸ’§ Hum {round(humidity)}% | Wind {round(wind)} mph')
          " "$WEATHER_DATA" "$AQI_DATA" "$NDVI_DATA")

          for i in 1 2 3; do
            gh gist edit "$GIST_ID" -f "aircloudy" - <<< "$WEATHER" && break
            echo "Retry $i..." && sleep 5
          done

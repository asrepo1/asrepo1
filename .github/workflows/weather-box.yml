name: Weather Box

on:
  schedule:
    - cron: "0 */12 * * *" # Every 12 hours
  workflow_dispatch: # Manual trigger

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch weather and update gist
        env:
          GH_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
          GIST_ID: 8fc319438657e698472538bf19a91c1d
        run: |
          # Menlo Park, CA coords
          LAT=37.4529
          LON=-122.1817

          # Fetch 7-day forecast from Open-Meteo (free, no key)
          DATA=$(curl -sf "https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&temperature_unit=fahrenheit&timezone=America/Los_Angeles&forecast_days=7")

          # Format as a clean text box
          WEATHER=$(echo "$DATA" | python3 -c "
          import json, sys
          from datetime import datetime

          codes = {
            0:'Clear',1:'Mostly Clear',2:'Partly Cloudy',3:'Overcast',
            45:'Fog',48:'Fog',51:'Lt Drizzle',53:'Drizzle',55:'Hvy Drizzle',
            61:'Lt Rain',63:'Rain',65:'Hvy Rain',71:'Lt Snow',73:'Snow',75:'Hvy Snow',
            80:'Lt Showers',81:'Showers',82:'Hvy Showers',95:'T-Storm',96:'T-Storm',99:'T-Storm'
          }
          icons = {
            0:'â˜€ï¸',1:'ğŸŒ¤',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«',48:'ğŸŒ«',51:'ğŸŒ¦',53:'ğŸŒ¦',55:'ğŸŒ¦',
            61:'ğŸŒ§',63:'ğŸŒ§',65:'ğŸŒ§',71:'ğŸŒ¨',73:'ğŸŒ¨',75:'ğŸŒ¨',80:'ğŸŒ§',81:'ğŸŒ§',82:'ğŸŒ§',
            95:'â›ˆ',96:'â›ˆ',99:'â›ˆ'
          }
          days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']

          d = json.load(sys.stdin)['daily']
          lines = ['â˜€ï¸ Menlo Park, CA â€” 7-Day Forecast','']
          for i in range(7):
              dt = datetime.strptime(d['time'][i], '%Y-%m-%d')
              day = days[dt.weekday()]
              date = dt.strftime('%b %d')
              code = d['weather_code'][i]
              icon = icons.get(code,'ğŸŒ¡')
              cond = codes.get(code,'???')
              hi = round(d['temperature_2m_max'][i])
              lo = round(d['temperature_2m_min'][i])
              rain = d['precipitation_probability_max'][i] or 0
              lines.append(f'{icon} {day} {date}  {hi}Â°/{lo}Â°F  {cond}  ğŸ’§{rain}%')
          now = datetime.now().strftime('%b %d, %H:%M PT')
          lines.append(f'')
          lines.append(f'Updated {now}')
          print('\n'.join(lines))
          ")

          # Update the gist
          gh gist edit "$GIST_ID" -f weather.txt - <<< "$WEATHER"

name: Weather Box

on:
  schedule:
    - cron: "0 * * * *" # Every hour
  workflow_dispatch: # Manual trigger

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Earth Engine API
        run: pip install earthengine-api

      - name: Fetch weather and update gist
        env:
          GH_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
          GEE_SERVICE_ACCOUNT_KEY: ${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}
          GIST_ID: 8fc319438657e698472538bf19a91c1d
          TZ: America/Los_Angeles
          LAT: "37.44783"
          LON: "-122.13604"
        run: |
          WEATHER_DATA=$(curl -sf "https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset,uv_index_max&hourly=temperature_2m,weather_code,cloud_cover,relative_humidity_2m,wind_speed_10m,apparent_temperature,uv_index&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America/Los_Angeles&forecast_days=5")

          AQI_DATA=$(curl -sf "https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&hourly=pm2_5,pm10,us_aqi&timezone=America/Los_Angeles&forecast_days=1")

          # NWS actual observation from Palo Alto Airport (ground truth for current hour)
          NWS_DATA=$(curl -sf -H "User-Agent: weather-gist" "https://api.weather.gov/stations/KPAO/observations/latest" || echo '{}')

          # Sentinel-2 NDVI via Google Earth Engine (10m resolution)
          NDVI_DATA=$(python3 .github/scripts/canopy.py 2>/dev/null || echo '{"ndvi":0,"prev_ndvi":0,"date":""}')

          WEATHER=$(python3 -c "
          import json, sys
          from datetime import datetime

          weather = json.loads(sys.argv[1])
          aq = json.loads(sys.argv[2])
          canopy = json.loads(sys.argv[3])
          nws = json.loads(sys.argv[4])

          # --- Icon system: cloud_cover % for clear/cloudy, WMO codes for precip ---
          precip_icons = {
            45:'ğŸŒ«',48:'ğŸŒ«',51:'ğŸŒ¦',53:'ğŸŒ¦',55:'ğŸŒ¦',
            61:'ğŸŒ§',63:'ğŸŒ§',65:'ğŸŒ§',71:'ğŸŒ¨',73:'ğŸŒ¨',75:'ğŸŒ¨',
            80:'ğŸŒ§',81:'ğŸŒ§',82:'ğŸŒ§',95:'â›ˆ',96:'â›ˆ',99:'â›ˆ'
          }
          def cloud_icon(pct):
              if pct <= 10: return 'â˜€'
              if pct <= 25: return 'ğŸŒ¤'
              if pct <= 50: return 'â›…'
              if pct <= 85: return 'ğŸŒ¥'
              return 'â˜'

          narrow = {'â˜€','â˜','â›…','â›ˆ'}
          def pad(ic):
              return ic + ' ' if ic in narrow else ic
          def safe(arr, idx):
              return (arr[min(idx, len(arr)-1)] if arr else 0) or 0

          def get_icon(idx):
              wc = h['weather_code'][idx]
              if wc >= 45:
                  return precip_icons.get(wc, 'ğŸŒ§')
              cc = safe(h.get('cloud_cover', []), idx)
              return cloud_icon(cc)

          # --- Moon phase for notable events ---
          def moon_phase(date_str):
              dt = datetime.strptime(date_str, '%Y-%m-%d')
              ref = datetime(2000, 1, 6, 18, 14)  # known new moon
              age = ((dt - ref).total_seconds() / 86400) % 29.530588853
              if age < 1 or age > 28.53: return 'ğŸŒ‘'
              if 6.38 < age < 8.38: return 'ğŸŒ“'
              if 13.27 < age < 15.27: return 'ğŸŒ•'
              if 21.15 < age < 23.15: return 'ğŸŒ—'
              return ''

          # --- Parse NWS observation for current hour (ground truth) ---
          nws_icon = None
          nws_desc = ''
          try:
              props = nws.get('properties', {})
              nws_desc = (props.get('textDescription', '') or '')
              layers = props.get('cloudLayers', [])
              amounts = {'CLR':0,'SKC':0,'FEW':12,'SCT':37,'BKN':68,'OVC':95}
              if layers:
                  max_cover = max(amounts.get(l.get('amount',''), 50) for l in layers)
                  nws_icon = cloud_icon(max_cover)
              desc_l = nws_desc.lower()
              if 'thunder' in desc_l or 'storm' in desc_l: nws_icon = 'â›ˆ'
              elif any(w in desc_l for w in ['rain','drizzle','shower']): nws_icon = 'ğŸŒ§'
              elif any(w in desc_l for w in ['snow','sleet','ice']): nws_icon = 'ğŸŒ¨'
              elif 'fog' in desc_l or 'mist' in desc_l: nws_icon = 'ğŸŒ«'
          except: pass

          days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']

          d = weather['daily']
          h = weather['hourly']

          now = datetime.now()
          hour_idx = 0
          for i, t in enumerate(h['time']):
              if datetime.strptime(t, '%Y-%m-%dT%H:%M') >= now:
                  hour_idx = i
                  break

          # --- Bias correction: adjust forecast cloud_cover using NWS ground truth ---
          nws_pct = None
          try:
              if nws_icon and nws.get('properties', {}).get('cloudLayers'):
                  nws_layers = nws['properties']['cloudLayers']
                  nws_amts = {'CLR':0,'SKC':0,'FEW':12,'SCT':37,'BKN':68,'OVC':95}
                  nws_pct = max(nws_amts.get(l.get('amount',''), 50) for l in nws_layers)
          except: pass
          if nws_pct is not None and h.get('cloud_cover'):
              model_now = safe(h['cloud_cover'], hour_idx)
              bias = model_now - nws_pct
              if abs(bias) > 15:
                  decay_rates = [0.90, 0.75, 0.55, 0.35, 0.15]
                  for offset, decay in enumerate(decay_rates, 1):
                      idx = hour_idx + offset
                      if idx < len(h['cloud_cover']):
                          correction = bias * decay
                          h['cloud_cover'][idx] = max(0, min(100, round(h['cloud_cover'][idx] - correction)))

          # --- Canopy from Google Earth Engine Sentinel-2 ---
          ndvi_val = canopy.get('ndvi', 0)
          ndvi_prev = canopy.get('prev_ndvi', 0)
          ndvi_date = canopy.get('date', '')

          if ndvi_val >= 0.6: canopy_dot = 'ğŸŸ¢'
          elif ndvi_val >= 0.4: canopy_dot = 'ğŸŸ¡'
          elif ndvi_val >= 0.2: canopy_dot = 'ğŸŸ '
          else: canopy_dot = 'ğŸ”´'

          delta = ndvi_val - ndvi_prev
          if delta > 0.02: trend = 'â†‘'
          elif delta < -0.02: trend = 'â†“'
          else: trend = 'â†’'

          ndvi_num = f'{ndvi_val:.2f}'
          ndvi_str = f'ğŸŒ³{canopy_dot}{ndvi_num}{trend}' if ndvi_val > 0 else 'ğŸŒ³--'

          # --- AQI + weather stats ---
          aq_h = aq.get('hourly', {})
          aq_times = aq_h.get('time', [])
          aq_idx = 0
          for i, t in enumerate(aq_times):
              if datetime.strptime(t, '%Y-%m-%dT%H:%M') >= now:
                  aq_idx = max(0, i - 1)
                  break
          us_aqi = safe(aq_h.get('us_aqi',[]), aq_idx)
          pm25 = safe(aq_h.get('pm2_5',[]), aq_idx)
          pm10 = safe(aq_h.get('pm10',[]), aq_idx)
          humidity = safe(h.get('relative_humidity_2m',[]), hour_idx)
          wind = safe(h.get('wind_speed_10m',[]), hour_idx)
          feels = safe(h.get('apparent_temperature',[]), hour_idx)
          uv = safe(h.get('uv_index',[]), hour_idx)
          sunrise = d.get('sunrise',[''])[0].split('T')[-1] if d.get('sunrise') else ''
          sunset = d.get('sunset',[''])[0].split('T')[-1] if d.get('sunset') else ''
          uv_max = d.get('uv_index_max',[0])[0] or 0

          # --- Comfort Index (0-100) ---
          comfort = 100.0
          if feels < 62: comfort -= min(30, (62 - feels) * 1.5)
          elif feels > 75: comfort -= min(30, (feels - 75) * 2)
          if humidity < 35: comfort -= min(12, (35 - humidity) * 0.6)
          elif humidity > 60: comfort -= min(15, (humidity - 60) * 0.5)
          if wind > 12: comfort -= min(12, (wind - 12) * 1.2)
          elif wind < 2: comfort -= 3
          comfort -= min(25, us_aqi * 0.2)
          if uv > 6: comfort -= min(10, (uv - 6) * 2)
          if ndvi_val > 0: comfort += min(5, ndvi_val * 8)
          comfort = max(0, min(100, round(comfort)))
          if comfort >= 80: c_dot = 'ğŸŸ¢'
          elif comfort >= 60: c_dot = 'ğŸŸ¡'
          elif comfort >= 40: c_dot = 'ğŸŸ '
          else: c_dot = 'ğŸ”´'

          # Line 1: hourly forecast + comfort index
          parts = []
          for i in range(hour_idx, min(hour_idx + 8, len(h['time']))):
              dt = datetime.strptime(h['time'][i], '%Y-%m-%dT%H:%M')
              hr = dt.strftime('%I%p').lstrip('0').rstrip('M').lower()
              ic = nws_icon if (i == hour_idx and nws_icon) else get_icon(i)
              parts.append(f'{hr}{ic}')
          hourly_line = ' '.join(parts)
          print(f'{hourly_line}  ğŸƒ{c_dot}{comfort}')

          # Lines 2-5: daily with spaced icons
          def day_icons(day_str):
              sample = [6, 9, 12, 15, 18, 21]
              r = []
              for j, t in enumerate(h['time']):
                  dt = datetime.strptime(t, '%Y-%m-%dT%H:%M')
                  if dt.strftime('%Y-%m-%d') == day_str and dt.hour in sample:
                      r.append(pad(get_icon(j)))
              return ' '.join(r)

          prev_hi = round(d['temperature_2m_max'][0])
          for i in range(1, 5):
              dt = datetime.strptime(d['time'][i], '%Y-%m-%d')
              day = days[dt.weekday()]
              hi_t = round(d['temperature_2m_max'][i])
              hourly = day_icons(d['time'][i])
              rain = d['precipitation_probability_max'][i] or 0
              delta_t = hi_t - prev_hi
              alert = ''
              if delta_t <= -5: alert = ' ğŸ”»'
              elif rain >= 50: alert = ' ğŸŒŠ'
              moon = moon_phase(d['time'][i])
              if moon: alert += moon
              print(f'{day} {hi_t:>2}Â° {hourly}{alert}')
              prev_hi = hi_t

          # Lines below fold (hidden from pinned preview)
          print()
          print(f'ğŸƒ Comfort {comfort}/100 {c_dot}')
          t_pen = min(30, (62-feels)*1.5) if feels<62 else min(30,(feels-75)*2) if feels>75 else 0
          h_pen = min(12,(35-humidity)*0.6) if humidity<35 else min(15,(humidity-60)*0.5) if humidity>60 else 0
          w_pen = min(12,(wind-12)*1.2) if wind>12 else 3 if wind<2 else 0
          a_pen = min(25, us_aqi*0.2)
          u_pen = min(10,(uv-6)*2) if uv>6 else 0
          n_bon = min(5, ndvi_val*8) if ndvi_val>0 else 0
          print(f'  temp {-round(t_pen)} hum {-round(h_pen)} wind {-round(w_pen)} aqi {-round(a_pen)} uv {-round(u_pen)} ndvi +{round(n_bon)}')
          src = 'Sentinel-2 10m' if ndvi_val > 0 else 'MODIS'
          ndvi_chg = f'{delta:+.2f}' if ndvi_val > 0 else '--'
          print(f'ğŸ›° NDVI {ndvi_num} ({ndvi_chg}) {trend} [{src}] {ndvi_date}')
          print(f'ğŸ’¨ AQI {us_aqi} | PM2.5 {round(pm25)} | PM10 {round(pm10)} ug/m3')
          print(f'ğŸŒ¡ Feels {round(feels)}Â° | UV {round(uv,1)}/{round(uv_max,1)} | â˜€ {sunrise}-{sunset}')
          print(f'ğŸ’§ Hum {round(humidity)}% | Wind {round(wind)} mph')
          # Ground vs Model cloud cover comparison
          model_cc = safe(h.get('cloud_cover', []), hour_idx)
          model_ic = cloud_icon(model_cc)
          if nws_desc:
              # Extract NWS cloud % from layers
              try:
                  nws_layers = nws.get('properties', {}).get('cloudLayers', [])
                  nws_amts = {'CLR':0,'SKC':0,'FEW':12,'SCT':37,'BKN':68,'OVC':95}
                  nws_pct = max(nws_amts.get(l.get('amount',''), 50) for l in nws_layers) if nws_layers else 0
              except: nws_pct = 0
              nws_ic = cloud_icon(nws_pct)
              diff = abs(model_cc - nws_pct)
              match = 'âœ“' if diff <= 20 else 'âœ—'
              print(f'ğŸ“¡ KPAO: {nws_desc} ({nws_pct}%){nws_ic} vs Mdl: {model_cc}%{model_ic} {match}')
          else:
              print(f'ğŸ“¡ NWS: unavail | Mdl: {model_cc}%{model_ic}')
          " "$WEATHER_DATA" "$AQI_DATA" "$NDVI_DATA" "$NWS_DATA")

          for i in 1 2 3; do
            gh gist edit "$GIST_ID" -f "aircloudy" - <<< "$WEATHER" && break
            echo "Retry $i..." && sleep 5
          done

name: Weather Box

on:
  schedule:
    - cron: "0 */12 * * *" # Every 12 hours
  workflow_dispatch: # Manual trigger

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch weather and update gist
        env:
          GH_TOKEN: ${{ secrets.GH_GIST_TOKEN }}
          GIST_ID: 8fc319438657e698472538bf19a91c1d
        run: |
          # 94025 = Menlo Park, CA
          LAT=37.4529
          LON=-122.1817

          # Fetch 7-day + current from Open-Meteo
          DATA=$(curl -sf "https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&current=temperature_2m,weather_code&temperature_unit=fahrenheit&timezone=America/Los_Angeles&forecast_days=7")

          WEATHER=$(echo "$DATA" | python3 -c "
          import json, sys
          from datetime import datetime

          icons = {
            0:'â˜€',1:'ðŸŒ¤',2:'â›…',3:'â˜',45:'ðŸŒ«',48:'ðŸŒ«',51:'ðŸŒ¦',53:'ðŸŒ¦',55:'ðŸŒ¦',
            61:'ðŸŒ§',63:'ðŸŒ§',65:'ðŸŒ§',71:'ðŸŒ¨',73:'ðŸŒ¨',75:'ðŸŒ¨',80:'ðŸŒ§',81:'ðŸŒ§',82:'ðŸŒ§',
            95:'â›ˆ',96:'â›ˆ',99:'â›ˆ'
          }
          labels = {
            0:'Clear',1:'Clear',2:'Cloudy',3:'Overcast',
            45:'Fog',48:'Fog',51:'Drizzle',53:'Drizzle',55:'Drizzle',
            61:'Rain',63:'Rain',65:'Rain',71:'Snow',73:'Snow',75:'Snow',
            80:'Showers',81:'Showers',82:'Showers',95:'Storm',96:'Storm',99:'Storm'
          }
          days = ['Mo','Tu','We','Th','Fr','Sa','Su']

          data = json.load(sys.stdin)
          d = data['daily']
          c = data['current']

          # Rain bar: â–‘ for each 20%
          def rain_bar(pct):
              filled = round(pct / 20)
              return 'â–“' * filled + 'â–‘' * (5 - filled)

          # Current conditions
          now_temp = round(c['temperature_2m'])
          now_code = c['weather_code']
          now_icon = icons.get(now_code, 'ðŸŒ¡')
          now_label = labels.get(now_code, '?')
          now_time = datetime.now().strftime('%I:%M%p').lstrip('0').lower()

          lines = []
          lines.append(f'ðŸ“ 94025 â”‚ {now_icon} {now_temp}Â°F {now_label} â”‚ {now_time}')
          lines.append(f'â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')

          for i in range(7):
              dt = datetime.strptime(d['time'][i], '%Y-%m-%d')
              day = days[dt.weekday()]
              dd = dt.strftime('%d')
              code = d['weather_code'][i]
              icon = icons.get(code, 'ðŸŒ¡')
              hi = round(d['temperature_2m_max'][i])
              lo = round(d['temperature_2m_min'][i])
              rain = d['precipitation_probability_max'][i] or 0
              bar = rain_bar(rain)
              lines.append(f'{day} {dd}  {icon} {hi:>3}Â°â”‚{lo:>3}Â°  {bar} {rain:>2}%')

          lines.append(f'â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
          lines.append(f'        â–“â–“â–“â–“â–“ = ðŸ’§100%    â–‘â–‘â–‘â–‘â–‘ = 0%')

          print('\n'.join(lines))
          ")

          gh gist edit "$GIST_ID" -f "weather.txt" - <<< "$WEATHER"
